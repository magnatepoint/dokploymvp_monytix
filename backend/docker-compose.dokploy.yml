# Docker Compose for Dokploy/Coolify deployment
# Set env vars in Coolify: Application â†’ Environment Variables
# Required: POSTGRES_URL, SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY,
#           SUPABASE_JWT_SECRET, FRONTEND_ORIGIN

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    # No host port mapping - Coolify routes via proxy. Add domain in Coolify UI (port 8001).
    expose:
      - "8001"
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - POSTGRES_URL=${POSTGRES_URL}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - FRONTEND_ORIGIN=${FRONTEND_ORIGIN}
    volumes:
      - backend-logs:/app/logs
      - backend-data:/app/data
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - mvp-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    command: celery -A app.celery_app worker --loglevel=info --concurrency=4
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - POSTGRES_URL=${POSTGRES_URL}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      - FRONTEND_ORIGIN=${FRONTEND_ORIGIN}
    volumes:
      - backend-logs:/app/logs
      - backend-data:/app/data
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      - redis
      - backend
    networks:
      - mvp-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    command: celery -A app.celery_app beat -s /tmp/celerybeat-schedule --loglevel=info
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - POSTGRES_URL=${POSTGRES_URL}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
    volumes:
      - backend-logs:/app/logs
      - backend-data:/app/data
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      - redis
      - backend
    networks:
      - mvp-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mvp-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  redis-data:
    driver: local
  backend-logs:
    driver: local
  backend-data:
    driver: local

networks:
  mvp-network:
    driver: bridge
